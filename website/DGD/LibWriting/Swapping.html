<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>DGD and LPC: Swapping</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link href="../../phantasmal.css" rel="stylesheet" type="text/css" />
</head>
<body>
<table width="95%" border="0" cellspacing="0" cellpadding="4">
  <tr>
    <td colspan="2"> <table width="100%" border="0" cellspacing="1"
        cellpadding="0" class="main">
        <tr>
          <td class="banner">The DGD Driver</td>
        </tr>
      </table></td>
  </tr>
  <tr>
    <td valign="top">
      <table width="25%"  border="0" cellspacing="1"
             cellpadding="0"  class="main">
        <tr>
          <td class="content" style="font-size: 120%">

          <ul style="margin: 0; padding-left: 10%">
            <li> <a href="../index.html">DGD &amp; LPC Page</a> </li>
	    <li> <a href="../LPC">LPC Textbook</a> </li>
	    <li> <a href="../Book/html">New LPC Introduction</a> </li>
          </ul>

        </td>
        </tr>
        <tr>
          <td class="content" align="center">
            <a href="http://validator.w3.org/check/referer">
            <img src="../../images/valid-xhtml10.gif" alt="Valid XHTML 1.0!"
             style="border:0;width:88px;height:31px" /></a><br />
            <img src="../../images/pixel.gif"
             style="border:0;width:88px;height:1px" alt="" /><br />
            <a href="http://jigsaw.w3.org/css-validator/check/referer">
            <img src="http://jigsaw.w3.org/css-validator/images/vcss"
             alt="Valid CSS!" style="border:0;width:88px;height:31px" />
            </a><br /><br /><br />
            <a href="http://sourceforge.net">
            <img src="http://sourceforge.net/sflogo.php?group_id=48659&amp;type=2"
             style="border: 0; width: 125; height: 37;"
	     alt="SourceForge.net Logo" /></a>
          </td>
        </tr>
      </table></td>
    <td> <table width="100%"  border="0" cellspacing="1" cellpadding="0" 
          class="main">
        <tr>
          <td class="heading">&nbsp;&nbsp;&middot;&nbsp;
	    <a href="http://phantasmal.sf.net/DGD">DGD Page</a> &gt;
	    <a href="http://phantasmal.sf.net/DGD/LibWriting">MUDLibs</a> &gt;
            <a href="">Swapping</a>
          </td>
        </tr>
        <tr>
          <td class="content">
  

  <h2> DGD's Swapping Behavior </h2>

  <p>
    DGD calls itself a &quot;disk-based&quot; server.  That means that
    DGD will swap out objects after they've been unused for awhile.
    It uses a standard LRU (Least Recently Used) metric to determine
    which objects should be removed from memory.  This swapping is
    entirely transparent from the point of view of the LPC code.  All
    LPC code executes as though every object was in RAM at all times,
    and objects will be pulled into memory as they are referenced.
  </p>

  <h3> The Configuration File </h3>

  <p>
    DGD's configuration file contains a parameter called
    swap_fragment.  That's the fraction of all objects that should be
    removed from memory.  For instance, if swap_fragment is equal to
    20, then one-twentieth of all objects will be swapped out at the
    end of every thread of execution.  A smaller swap_fragment will
    cause DGD to use less memory, but will also mean more disk access
    is necessary as objects are written.
  </p>

  <p>
    Objects are stored as sectors.  The sector_size parameter tells
    how large a single sector is, in bytes.  Every object takes up a
    multiple of the sector size in the swap file.  So if the sector
    size were 1024, no object could take less than one kilobyte to
    store in the swap file.  An object with 3217 bytes of data would
    wind up actually taking 4096 bytes in the swap file, or four
    sectors.  A small sector size can save some space that way, though
    a very small sector size (like, say, 64 bytes) will require the
    DGD server to use up a lot of processor time and memory in
    managing so many sectors.
  </p>

  <p>
    The swap_cache config parameter says how many sectors can be in
    RAM at once.  If this is large, DGD runs fast.  If it's small, DGD
    takes less memory.
  </p>

  <h3> Transparency </h3>

  <p>
    All of this nifty swapping stuff Just Happens(tm).  That is, you
    should never, as a programmer, specifically need to request it.
    Objects are swapped out at the end of threads according to the
    swap_fragment configuration parameter, and they're swapped in when
    you use them.  It should never be necessary to explicitly request
    a swap-in for an object.
  </p>

  <p>
    If you ever wish to explicitly request a swap-out, there's a kfun
    called swapout() which will swap <i>every</i> object out.
  </p>

  <p>
    An object is swapped back into memory when one of its functions is
    called.  Just the first sector will be swapped in when status() is
    called on the object.  Note that calling find_object() does not
    swap the object in.  Only operations that access the object's
    individual information need to do so.
  </p>

  <p>
    When an object is swapped out, it will only be written out if it
    changes.  Having large objects that change frequently can make for
    much slower swapping.  Consider separating the highly-changeable
    parts of the objects into smaller DGD objects that will swap
    separately.
  </p>

  <h3> Memory Use </h3>

  <p>
    You'll find that the in-RAM memory use of your library, measured
    in sectors, is driven by several things.  Roughly in order of
    importance, those things are: 1) the number of rooms and portable
    items in your world.  2) The time your MUD has been running
    &mdash; DGD is disk-based, so content is loaded as it is visited.
    3) The number of active, moving users.  Active users will continue
    to load content by seeing and using it.  It would otherwise be
    swapped out.  And 4) the aggressiveness of your cleanup routines,
    including things like swapping.  The more aggressively you clean
    up, the shorter the time that 'transient' memory (memory that is
    used briefly and discarded) will take up space after it is used.
  </p>

  <h3> Disabling Swapping </h3>

  <p>
    If you experience very high usage by your MUD of your machine's
    CPU, but DGD's usage of ticks doesn't account for it, then DGD's
    housekeeping tasks, especially swapping, may account for the
    difference.  If your MUD can fit entirely in RAM, you can find out
    if swapping is your problem by temporarily turning off swapping
    and only using RAM.
  </p>

  <p>
    In your DGD configuration file, set swap_fragment to 0.  That will
    turn off ordinary swapping, but not certain operations where all
    objects are swapped out to make room for larger contiguous blocks
    of static memory.  By setting static_chunk to 0 as well, you can
    eliminate all swapping in your application, even those operations.
  </p>

  <p>
    Remember to turn swapping back on afterward!
  </p>

  <h3> Massive Numbers of Objects </h3>

  <p>
    For lots of objects, you'll have to first increase the maximum
    number of objects and maximum number of sectors in the DGD
    configuration file.  Both are quite small initially.  DGD was
    initially designed to run in as little as a single megabyte of
    memory, so its starting configuration isn't appropriate for large
    MUDs.  You'll have to change the file a bit.
  </p>

  <p>
    Luckily, there is essentially no penalty for have a very large
    maximum number of objects, at least if you have the disk space to
    permit it, and the RAM to hold the ones that are currently in
    memory.
  </p>

  <p>
    The maximum number of possible objects depends on your operating
    system and your version of DGD.  But remember that your swapfile
    will have to be no larger than the largest file your operating
    system supports, which can be as small as 2GB or smaller.  Also,
    with the default data type for object numbers, you can't have more
    than 4 billion objects total.  That's changeable, but it would
    require significant effort.
  </p>

<hr />

<pre>
From: dgd@dworkin.nl (Felix A. Croes)
Date: Tue Apr  5 01:29:01 2005
Subject: [DGD] Question about object references

Steve Wooster wrote:

>      I just remembered another question I had... an object isn't loaded 
> from the swap-file unless a function is called in it, right? For example, 
> if I had a list of, say, 10000 objects, and I wanted to process it (maybe 
> calling call_outs or something each with a different object as an argument) 
> without calling functions in the object or looking at their status or 
> anything like that, I could iterate through the whole array without using 
> much more memory than what the array takes, right? Thanks.

As long as you don't access the objects themselves, you can safely
manipulate an array of them (including testing whether objects have
been destructed) without loading any into memory.

Regards,
Dworkin
</pre>

  <p style="text-size: 150%"> <a href="../index.html"> Back to top level
    </a> </p>
            <address>
            <span><a href="mailto:angelbob-remove-spamfree@spamfree.users.sf.net">Noah Gibbs</a></span>
            </address></td>
        </tr>
      </table></td>
  </tr>
</table>
</body>
</html>
